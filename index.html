<script>
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        let allProducts = [];
        let cart = [];
        let currentModalProduct = null;
        let userLocationGPS = null;
        let userMapLocation = null;
        let map, marker;
        
        // Ø±Ø§Ø¨Ø· Ø¬ÙˆØ¬Ù„ Ø´ÙŠØª (CSV)
        const sheetId = "2PACX-1vTMFYLXX8QRtMctQ5g4A21ftngOtMfKmBpbBpA7T4aDAhwKoRxYJ-JtWjRylqV1dpg0Lyjoj4JEmAJH";
        const csvUrl = `https://docs.google.com/spreadsheets/d/e/${sheetId}/pub?output=csv`;

        // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        function init() {
            Papa.parse(csvUrl, {
                download: true,
                header: true,
                skipEmptyLines: true, // ØªØ®Ø·ÙŠ Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„ÙØ§Ø±ØºØ©
                complete: function(results) {
                    // Ù‡Ù†Ø§ Ù†Ù‚ÙˆÙ… Ø¨ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
                    allProducts = results.data.map(item => {
                        return {
                            // ÙŠÙØ­Øµ ÙƒÙ„ Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„Ø§Øª Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯
                            Name: item.Name || item.name || item['Ø§Ù„Ø§Ø³Ù…'] || item['Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬'] || item['Ø§Ø³Ù…'],
                            Price: item.Price || item.price || item['Ø§Ù„Ø³Ø¹Ø±'] || item['Ø³Ø¹Ø±'],
                            Image: item.Image || item.image || item['Ø§Ù„ØµÙˆØ±Ø©'] || item['Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©'] || item['ØµÙˆØ±Ø©'],
                            Description: item.Description || item.description || item['Ø§Ù„ÙˆØµÙ'] || item['ØªÙØ§ØµÙŠÙ„'] || ''
                        };
                    }).filter(p => p.Name); // Ù†Ø­Ø°Ù Ø£ÙŠ ØµÙ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ø³Ù…

                    if (allProducts.length === 0) {
                        alert("ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ù„Ù ÙˆÙ„ÙƒÙ† Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬Ø§Øª! ØªØ£ÙƒØ¯ Ù…Ù† ÙƒØªØ§Ø¨Ø© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø³Ø¹Ø±ØŒ Ø§Ù„ØµÙˆØ±Ø©).");
                    }

                    renderProducts();
                    document.getElementById('loading').style.display = 'none';
                },
                error: function(err) {
                    document.getElementById('loading').innerHTML = '<p style="color:red">ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheet. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ù†ØªØ±Ù†Øª.</p>';
                }
            });
        }

        // 2. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        function renderProducts() {
            const container = document.getElementById('products-container');
            container.innerHTML = '';
            
            if (allProducts.length === 0) {
                container.innerHTML = '<p style="text-align:center; width:100%;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
                return;
            }

            allProducts.forEach((p, index) => {
                // ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù†Øª Ø§Ù„Ø®Ø§Ù†Ø© ÙØ§Ø±ØºØ©
                const img = p.Image ? p.Image : 'https://via.placeholder.com/300?text=No+Image';
                const price = p.Price ? p.Price : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const name = p.Name;
                
                container.innerHTML += `
                    <div class="product-card" onclick="openProductDetails(${index})">
                        <img src="${img}" class="product-img" onerror="this.src='https://via.placeholder.com/300?text=Error'">
                        <div class="product-info">
                            <h3 class="product-title">${name}</h3>
                            <div class="product-price">${price}</div>
                        </div>
                    </div>
                `;
            });
        }

        // 3. ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬
        function openProductDetails(index) {
            currentModalProduct = allProducts[index];
            
            // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ÙƒØ³ÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
            const imgUrl = currentModalProduct.Image || 'https://via.placeholder.com/300?text=No+Image';
            
            document.getElementById('m-img').src = imgUrl;
            document.getElementById('m-title').innerText = currentModalProduct.Name;
            document.getElementById('m-price').innerText = currentModalProduct.Price || '';
            document.getElementById('m-desc').innerText = currentModalProduct.Description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªØ§Ø­';
            document.getElementById('m-qty').value = 1;
            
            document.getElementById('product-modal').style.display = 'flex';
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
        function updateModalQty(change) {
            const input = document.getElementById('m-qty');
            let val = parseInt(input.value) + change;
            if (val < 1) val = 1;
            input.value = val;
        }

        // 4. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø©
        function addToCartFromModal() {
            const qty = parseInt(document.getElementById('m-qty').value);
            const existingItem = cart.find(item => item.product.Name === currentModalProduct.Name);

            if (existingItem) {
                existingItem.qty += qty;
            } else {
                cart.push({ product: currentModalProduct, qty: qty });
            }

            updateCartUI();
            closeModal('product-modal');
            // ØªÙ†Ø¨ÙŠÙ‡ ØµØºÙŠØ±
            alert('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©');
        }

        function updateCartUI() {
            document.getElementById('cart-count').innerText = cart.length;
        }

        function openCart() {
            const container = document.getElementById('cart-items');
            container.innerHTML = '';
            let total = 0;

            if (cart.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:20px;">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</p>';
            }

            cart.forEach((item, index) => {
                let priceClean = item.product.Price ? item.product.Price.replace(/[^0-9.]/g, '') : "0"; 
                let itemTotal = parseFloat(priceClean) * item.qty;
                if(!isNaN(itemTotal)) total += itemTotal;

                const img = item.product.Image || 'https://via.placeholder.com/50';

                container.innerHTML += `
                    <div class="cart-item">
                        <img src="${img}" class="cart-item-img">
                        <div class="cart-item-details">
                            <div style="font-weight:bold">${item.product.Name}</div>
                            <div style="color:#777; font-size:0.9rem">${item.product.Price} x ${item.qty}</div>
                        </div>
                        <div onclick="removeFromCart(${index})" class="delete-item"><i class="fas fa-trash"></i></div>
                    </div>
                `;
            });

            document.getElementById('cart-total-price').innerText = total.toLocaleString();
            document.getElementById('cart-modal').style.display = 'flex';
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            openCart();
            updateCartUI();
        }

        // 5. Checkout ÙˆØ§Ù„Ø®Ø±Ø§Ø¦Ø·
        function openCheckout() {
            if (cart.length === 0) return alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©');
            closeModal('cart-modal');
            document.getElementById('checkout-modal').style.display = 'flex';
            
            setTimeout(() => {
                if (!map) initMap();
                map.invalidateSize();
            }, 200);
        }

        function getMyLocation() {
            const status = document.getElementById('gps-status');
            status.innerText = "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...";
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    userLocationGPS = `https://www.google.com/maps?q=${lat},${lng}`;
                    status.innerText = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ù†Ø¬Ø§Ø­";
                }, () => {
                    status.innerText = "âŒ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ GPS";
                    status.style.color = "red";
                });
            } else {
                status.innerText = "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹";
            }
        }

        function initMap() {
            map = L.map('map').setView([33.3128, 44.3615], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);

            marker = L.marker([33.3128, 44.3615], {draggable: true}).addTo(map);
            
            marker.on('dragend', function(event) {
                var position = marker.getLatLng();
                userMapLocation = `https://www.google.com/maps?q=${position.lat},${position.lng}`;
                document.getElementById('map-status').innerText = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù‡Ø¯ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©";
            });
            
            map.on('click', function(e) {
                marker.setLatLng(e.latlng);
                userMapLocation = `https://www.google.com/maps?q=${e.latlng.lat},${e.latlng.lng}`;
                document.getElementById('map-status').innerText = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù‡Ø¯ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©";
            });
        }

        // 6. Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨
        function sendToWhatsapp() {
            const name = document.getElementById('c-name').value;
            const phone = document.getElementById('c-phone').value;

            if (!name || !phone) return alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ');

            let message = `*Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ù…ØªØ¬Ø± YTime* %0A`;
            message += `---------------------------%0A`;
            message += `*Ø§Ù„Ø§Ø³Ù…:* ${name} %0A`;
            message += `*Ø§Ù„Ù‡Ø§ØªÙ:* ${phone} %0A`;
            message += `---------------------------%0A`;
            message += `*Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:* %0A`;

            let totalPrice = document.getElementById('cart-total-price').innerText;

            cart.forEach(item => {
                message += `- ${item.product.Name} (Ø§Ù„Ø¹Ø¯Ø¯: ${item.qty}) %0A`;
            });

            message += `---------------------------%0A`;
            message += `*Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:* ${totalPrice} Ø¯.Ø¹ %0A`;
            
            if (userLocationGPS) {
                message += `ğŸ“ *Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø²Ø¨ÙˆÙ† (GPS):* %0A ${userLocationGPS} %0A`;
            }
            
            if (userMapLocation) {
                message += `ğŸ *Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù‡Ø¯ÙŠØ© (Ø§Ù„Ø®Ø±ÙŠØ·Ø©):* %0A ${userMapLocation} %0A`;
            }

            const whatsappNumber = "9647858644168"; 
            const url = `https://wa.me/${whatsappNumber}?text=${message}`;
            
            window.open(url, '_blank');
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        }

        init();
    </script>
