<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NUVIA</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;900&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <!-- ÿ£ŸäŸÇŸàŸÜÿßÿ™ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #050505;
            --bg-card: #121212;
            --gold: #D4AF37;
            --gold-dim: #aa8c2c;
            --gold-gradient: linear-gradient(45deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            --text-light: #f4f4f4;
            --glass: rgba(255, 255, 255, 0.05);
            --border-glass: rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { background-color: var(--bg-dark); color: var(--text-light); padding-bottom: 80px; overflow-x: hidden; }

        /* --- PRELOADER --- */
        #preloader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            transition: opacity 0.5s ease;
        }
        .loader-logo {
            font-family: 'Cinzel', serif; font-size: 3rem; 
            background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: shine 2s infinite linear;
        }
        @keyframes shine { 0% {filter: brightness(1);} 50% {filter: brightness(1.5);} 100% {filter: brightness(1);} }

        /* --- HEADER --- */
        header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(5, 5, 5, 0.9); backdrop-filter: blur(10px);
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-glass);
        }
        .brand { font-family: 'Cinzel', serif; font-size: 1.8rem; color: var(--gold); letter-spacing: 2px; font-weight: 700; }
        
        .cart-icon { position: relative; cursor: pointer; color: var(--gold); font-size: 1.4rem; }
        .cart-count {
            position: absolute; top: -8px; right: -8px;
            background: red; color: white; font-size: 0.7rem; font-weight: bold;
            width: 18px; height: 18px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
        }

        /* --- HERO --- */
        .hero {
            height: 350px; position: relative;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; overflow: hidden;
            background: radial-gradient(circle, #1a1a1a 0%, #000000 100%);
        }
        .hero::after {
            content: ''; position: absolute; width: 200%; height: 200%;
            background: url('https://www.transparenttextures.com/patterns/stardust.png');
            opacity: 0.3; animation: rotate 60s linear infinite;
        }
        @keyframes rotate { from {transform: rotate(0deg);} to {transform: rotate(360deg);} }
        
        .hero h1 { font-family: 'Cinzel', serif; font-size: 3.5rem; color: var(--gold); margin-bottom: 10px; z-index: 2; text-shadow: 0 0 20px rgba(212, 175, 55, 0.3); }
        .hero p { color: #888; letter-spacing: 3px; z-index: 2; text-transform: uppercase; font-size: 0.9rem; }

        /* --- CONTROLS (Search & Filter) --- */
        .controls-area {
            position: sticky; top: 70px; z-index: 90;
            background: var(--bg-dark); padding: 15px;
            border-bottom: 1px solid var(--border-glass);
        }
        
        .search-box {
            position: relative; width: 100%; max-width: 600px; margin: 0 auto 15px auto;
        }
        .search-input {
            width: 100%; background: #1a1a1a; border: 1px solid #333;
            padding: 12px 40px 12px 15px; border-radius: 30px; color: #fff;
            transition: 0.3s;
        }
        .search-input:focus { border-color: var(--gold); box-shadow: 0 0 10px rgba(212, 175, 55, 0.2); }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #666; }

        .filters {
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px;
            scrollbar-width: none; justify-content: center;
        }
        .filters::-webkit-scrollbar { display: none; }
        
        .filter-btn {
            background: transparent; border: 1px solid #333; color: #888;
            padding: 8px 20px; border-radius: 20px; white-space: nowrap; cursor: pointer; transition: 0.3s;
        }
        .filter-btn.active, .filter-btn:hover { background: var(--gold); color: #000; border-color: var(--gold); font-weight: bold; }

        /* --- GRID --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .products-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 20px;
        }
        @media(min-width: 768px) { .products-grid { grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 30px; } }

        .product-card {
            background: var(--bg-card); border: 1px solid var(--border-glass);
            border-radius: 15px; overflow: hidden; position: relative;
            transition: 0.3s; display: flex; flex-direction: column;
        }
        .product-card:hover { transform: translateY(-5px); border-color: var(--gold-dim); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        .card-img-wrap { position: relative; padding-top: 100%; overflow: hidden; cursor: pointer; }
        .card-img {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;
            transition: 0.5s;
        }
        .product-card:hover .card-img { transform: scale(1.1); }

        /* Badge Logic (Example) */
        .badge {
            position: absolute; top: 10px; left: 10px;
            background: var(--gold); color: #000; padding: 3px 10px;
            font-size: 0.7rem; font-weight: bold; border-radius: 4px; z-index: 2;
        }

        .card-info { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .card-cat { color: var(--gold); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 5px; }
        .card-title { font-size: 1rem; margin-bottom: 5px; font-weight: 600; color: #fff; }
        .card-price { font-size: 1.1rem; font-weight: bold; color: #ddd; margin-top: auto; }
        
        .btn-add {
            width: 100%; padding: 10px; margin-top: 10px;
            background: transparent; border: 1px solid var(--gold); color: var(--gold);
            border-radius: 8px; cursor: pointer; transition: 0.3s; font-weight: bold;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-add:hover { background: var(--gold); color: #000; }

        /* --- PRODUCT DETAIL MODAL --- */
        .product-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 2000;
            justify-content: center; align-items: center; padding: 20px;
        }
        .pm-content {
            background: #1a1a1a; width: 100%; max-width: 800px;
            border-radius: 20px; overflow: hidden; display: flex; flex-direction: column;
            border: 1px solid var(--gold-dim); position: relative;
            animation: zoomIn 0.3s ease;
        }
        @media(min-width: 768px) { .pm-content { flex-direction: row; height: 500px; } }
        @keyframes zoomIn { from {transform: scale(0.9); opacity: 0;} to {transform: scale(1); opacity: 1;} }

        .pm-img-box { width: 100%; height: 300px; position: relative; }
        @media(min-width: 768px) { .pm-img-box { width: 50%; height: 100%; } }
        .pm-img { width: 100%; height: 100%; object-fit: cover; }
        
        .pm-details { padding: 30px; width: 100%; display: flex; flex-direction: column; justify-content: center; }
        @media(min-width: 768px) { .pm-details { width: 50%; } }

        .close-pm { position: absolute; top: 15px; left: 15px; color: #fff; font-size: 1.5rem; cursor: pointer; z-index: 10; background: rgba(0,0,0,0.5); width: 35px; height: 35px; border-radius: 50%; display: flex; justify-content: center; align-items: center; }

        /* --- CART MODAL --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 1000; justify-content: flex-end;
        }
        .modal-content {
            background: #151515; width: 100%; max-width: 450px; height: 100%;
            padding: 25px; border-left: 1px solid #333; overflow-y: auto;
            animation: slideLeft 0.3s ease; display: flex; flex-direction: column;
        }
        @keyframes slideLeft { from {transform: translateX(100%);} to {transform: translateX(0);} }

        /* Form & Inputs */
        .form-group { margin-bottom: 15px; }
        input, select {
            width: 100%; background: #222; border: 1px solid #333; color: #fff;
            padding: 12px; border-radius: 8px; margin-top: 5px;
        }
        .gps-btn {
            background: #222; border: 1px dashed var(--gold); color: var(--gold);
            padding: 10px; border-radius: 8px; width: 100%; cursor: pointer; margin-top: 10px;
        }
        .whatsapp-btn {
            background: linear-gradient(to right, #25D366, #128C7E); color: white;
            width: 100%; padding: 15px; border: none; border-radius: 10px;
            font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 20px;
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.2);
        }

        /* --- TOAST NOTIFICATION --- */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff;
            text-align: center; border-radius: 50px; padding: 16px; position: fixed;
            z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%);
            border: 1px solid var(--gold); box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    </style>
</head>
<body>

    <!-- ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ -->
    <div id="preloader">
        <div class="loader-logo">NUVIA</div>
        <p style="color:#666; margin-top:10px; letter-spacing:2px;">LOADING LUXURY</p>
    </div>

    <!-- ÿ•ÿ¥ÿπÿßÿ± ŸÖŸÜÿ®ÿ´ŸÇ -->
    <div id="toast"><i class="fas fa-check-circle" style="color:var(--gold)"></i> ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ≥ŸÑÿ©</div>

    <!-- ÿßŸÑŸáŸäÿØÿ± -->
    <header>
        <div class="brand">NUVIA</div>
        <div class="cart-icon" onclick="openCart()">
            <i class="fas fa-shopping-bag"></i>
            <span class="cart-count" id="cart-count">0</span>
        </div>
    </header>

    <!-- ÿßŸÑŸàÿßÿ¨Ÿáÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© -->
    <div class="hero">
        <h1>NUVIA PERFUMES</h1>
        <p>ÿßŸÉÿ™ÿ¥ŸÅ ÿ¨ŸàŸáÿ± ÿßŸÑÿ£ŸÜÿßŸÇÿ©</p>
    </div>

    <!-- ÿ£ÿØŸàÿßÿ™ ÿßŸÑÿ™ÿ≠ŸÉŸÖ -->
    <div class="controls-area">
        <div class="search-box">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" id="search-input" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿπÿ∑ÿ±ÿå ÿπŸàÿØÿå ÿ£Ÿà ŸÖÿ≥ŸÉ..." onkeyup="searchProducts()">
        </div>
        <div class="filters" id="filters-container">
            <button class="filter-btn active" onclick="filterProducts('all')">ÿßŸÑŸÉŸÑ</button>
        </div>
    </div>

    <div class="container">
        <div class="products-grid" id="products-container">
            <!-- ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸáŸÜÿß -->
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ (Quick View) -->
    <div class="product-modal" id="productModal">
        <div class="pm-content">
            <div class="close-pm" onclick="closeProductModal()">&times;</div>
            <div class="pm-img-box">
                <img src="" id="pm-img" class="pm-img">
            </div>
            <div class="pm-details">
                <span id="pm-cat" style="color:var(--gold); text-transform:uppercase;"></span>
                <h2 id="pm-title" style="font-family:'Cinzel'; margin:10px 0; font-size:2rem;"></h2>
                <p id="pm-desc" style="color:#aaa; line-height:1.6; margin-bottom:20px;"></p>
                <div style="margin-top:auto">
                    <h3 id="pm-price" style="font-size:1.5rem; color:#fff; margin-bottom:15px;"></h3>
                    <button class="whatsapp-btn" style="margin:0; background:var(--gold-gradient); color:#000;" id="pm-add-btn">
                        ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ÿßŸÑŸÖÿ¨ŸÖŸàÿπÿ© <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ≥ŸÑÿ© -->
    <div class="modal" id="cartModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="font-family:'Cinzel'; color:var(--gold);">YOUR CART</h2>
                <span onclick="closeCart()" style="cursor:pointer; font-size:1.5rem;">&times;</span>
            </div>
            
            <div id="cart-items" style="flex-grow:1; overflow-y:auto; margin-bottom:20px;"></div>
            
            <div id="checkout-section" style="border-top:1px solid #333; padding-top:20px;">
                <label style="color:#888; font-size:0.9rem;">ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ÿ≠ŸÜ</label>
                <input type="text" id="cust-name" placeholder="ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿ±ŸäŸÖ">
                <select id="cust-gov" onchange="calculateTotal()">
                    <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ≠ÿßŸÅÿ∏ÿ©...</option>
                </select>
                <button type="button" class="gps-btn" onclick="getLocation()" id="gps-btn-el">
                    <i class="fas fa-map-marker-alt"></i> ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
                </button>
                <input type="hidden" id="google-map-link">
                <input type="tel" id="cust-phone" placeholder="ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ">

                <div style="background:#222; padding:15px; border-radius:10px; margin-top:15px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; color:#aaa;">
                        <span>ÿßŸÑŸÖÿ¨ŸÖŸàÿπ</span><span id="sub-total">0</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; color:#aaa;">
                        <span>ÿßŸÑÿ™ŸàÿµŸäŸÑ</span><span id="delivery-cost">0</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-weight:bold; color:var(--gold); font-size:1.2rem; border-top:1px solid #444; padding-top:10px;">
                        <span>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</span><span id="final-total">0</span>
                    </div>
                </div>

                <button class="whatsapp-btn" onclick="sendOrder()">
                    ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ∑ŸÑÿ® <i class="fab fa-whatsapp"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ======================== ÿßŸÑÿ±Ÿàÿßÿ®ÿ∑ ========================
        const PRODUCTS_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQdWOMb2scsi_GzqX-kFOhYGx4vTu-V2R4--h7A6hS1UbU_HyT58I5VQ6Ux3RvzynvjCdPLaO4h5NOg/pub?gid=0&single=true&output=csv';
        const SETTINGS_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQdWOMb2scsi_GzqX-kFOhYGx4vTu-V2R4--h7A6hS1UbU_HyT58I5VQ6Ux3RvzynvjCdPLaO4h5NOg/pub?gid=491751433&single=true&output=csv';
        // =========================================================

        let products = [];
        let filteredProducts = [];
        let cart = [];
        let deliveryRates = {}; 
        let storePhone = '';

        // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖŸàŸÇÿπ
        window.onload = async function() {
            // ÿ•ÿÆŸÅÿßÿ° ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
            setTimeout(() => {
                document.getElementById('preloader').style.opacity = '0';
                setTimeout(() => document.getElementById('preloader').style.display = 'none', 500);
            }, 1500);

            loadCartFromStorage();
            await loadAllData();
        };

        // ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©
        function saveCartToStorage() { localStorage.setItem('nuvia_cart', JSON.stringify(cart)); }
        function loadCartFromStorage() {
            const savedCart = localStorage.getItem('nuvia_cart');
            if (savedCart) { cart = JSON.parse(savedCart); updateCartCount(); }
        }

        // ÿ¨ŸÑÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        async function loadAllData() {
            try {
                const prodRes = await fetch(PRODUCTS_CSV);
                const prodText = await prodRes.text();
                products = mapProducts(parseCSV(prodText)); 
                filteredProducts = products; // ŸÜÿ≥ÿÆÿ© ŸÑŸÑÿ®ÿ≠ÿ´

                const setRes = await fetch(SETTINGS_CSV);
                const setText = await setRes.text();
                processSettings(parseCSV(setText));
                
                renderProducts(products);
                renderFilters();
            } catch (error) { console.error("Error:", error); }
        }

        function mapProducts(rawItems) {
            return rawItems.map(item => ({
                id: item['ÿßŸÑÿ™ÿ≥ŸÑÿ≥ŸÑ'],
                name: item['ÿßÿ≥ŸÖ_ÿßŸÑŸÖŸÜÿ™ÿ¨'],
                price: Number(item['ÿßŸÑÿ≥ÿπÿ±']),
                category: item['ÿßŸÑŸÇÿ≥ŸÖ'],
                image: item['ÿ±ÿßÿ®ÿ∑_ÿßŸÑÿµŸàÿ±ÿ©'],
                description: item['ÿßŸÑŸàÿµŸÅ']
            })).filter(item => item.name);
        }

        function processSettings(data) {
            const govSelect = document.getElementById('cust-gov');
            data.forEach(row => {
                const type = row['ÿßŸÑŸÜŸàÿπ'], key = row['ÿßŸÑÿ®ŸäÿßŸÜ'], val = row['ÿßŸÑŸÇŸäŸÖÿ©'];
                if(type === 'ÿπÿßŸÖ' && key === 'Ÿàÿßÿ™ÿ≥ÿßÿ®') storePhone = val;
                if(type === 'ÿ™ŸàÿµŸäŸÑ') {
                    deliveryRates[key] = Number(val);
                    let opt = document.createElement('option');
                    opt.value = key; opt.textContent = key;
                    govSelect.appendChild(opt);
                }
            });
        }

        // ÿßŸÑÿπÿ±ÿ∂ ŸàÿßŸÑÿ®ÿ≠ÿ´
        function renderProducts(items) {
            const container = document.getElementById('products-container');
            container.innerHTML = '';
            
            if(items.length === 0) {
                container.innerHTML = '<p style="grid-column:1/-1; text-align:center; padding:40px; color:#666">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ŸÖÿ∑ÿßÿ®ŸÇÿ©</p>';
                return;
            }

            items.forEach((p, index) => {
                const imgUrl = (p.image && p.image.length > 5) ? p.image : 'https://via.placeholder.com/400x400/111/D4AF37?text=NUVIA';
                // ŸÖÿ≠ÿßŸÉÿßÿ© ÿ®ÿßÿØÿ¨ ÿπÿ¥Ÿàÿßÿ¶Ÿä (ÿ¨ÿØŸäÿØ) ŸÑÿßÿ∂ŸÅÿßÿ° ÿßŸÑÿ≠ŸäŸàŸäÿ©
                const badge = (index % 3 === 0) ? '<span class="badge">ÿ¨ÿØŸäÿØ</span>' : ''; 

                container.innerHTML += `
                    <div class="product-card" style="animation: fadeInUp 0.5s ease forwards; animation-delay:${index*50}ms">
                        <div class="card-img-wrap" onclick="openProductModal('${p.id}')">
                            ${badge}
                            <img src="${imgUrl}" class="card-img" loading="lazy">
                        </div>
                        <div class="card-info">
                            <span class="card-cat">${p.category}</span>
                            <h3 class="card-title">${p.name}</h3>
                            <div class="card-price">${p.price.toLocaleString()} ÿØ.ÿπ</div>
                            <button class="btn-add" onclick="addToCart('${p.id}')">
                                ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ≥ŸÑÿ© <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
        }
        // ÿ≥ÿ™ÿßŸäŸÑ ÿßŸÑÿßŸÜŸäŸÖŸäÿ¥ŸÜ
        document.head.insertAdjacentHTML('beforeend', '<style>@keyframes fadeInUp { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }</style>');

        function searchProducts() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const results = products.filter(p => p.name.toLowerCase().includes(query) || p.category.toLowerCase().includes(query));
            renderProducts(results);
        }

        function renderFilters() {
            const categories = ['all', ...new Set(products.map(p => p.category))];
            const container = document.getElementById('filters-container');
            container.innerHTML = '';
            categories.forEach(cat => {
                if(!cat) return;
                const btn = document.createElement('button');
                btn.className = cat === 'all' ? 'filter-btn active' : 'filter-btn';
                btn.textContent = cat === 'all' ? 'ÿßŸÑŸÉŸÑ' : cat;
                btn.onclick = (e) => filterProducts(cat, e);
                container.appendChild(btn);
            });
        }

        function filterProducts(cat, event) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            if(event) event.target.classList.add('active');
            
            const list = cat === 'all' ? products : products.filter(p => p.category === cat);
            // ÿ™ÿµŸÅŸäÿ± ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜÿØ ÿßŸÑŸÅŸÑÿ™ÿ±ÿ©
            document.getElementById('search-input').value = ''; 
            renderProducts(list);
        }

        // Modal Logic (ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨)
        function openProductModal(id) {
            const p = products.find(x => x.id == id);
            if(!p) return;
            
            document.getElementById('pm-img').src = (p.image && p.image.length > 5) ? p.image : 'https://via.placeholder.com/400';
            document.getElementById('pm-cat').innerText = p.category;
            document.getElementById('pm-title').innerText = p.name;
            document.getElementById('pm-desc').innerText = p.description || 'ÿπÿ∑ÿ± ŸÅÿßÿÆÿ± Ÿäÿ™ŸÖŸäÿ≤ ÿ®ÿ´ÿ®ÿßÿ™ ÿπÿßŸÑŸä ŸàŸÅŸàÿ≠ÿßŸÜ ŸÖŸÖŸäÿ≤.';
            document.getElementById('pm-price').innerText = p.price.toLocaleString() + ' ÿØ.ÿπ';
            
            const btn = document.getElementById('pm-add-btn');
            btn.onclick = function() { addToCart(p.id); closeProductModal(); };
            
            document.getElementById('productModal').style.display = 'flex';
        }
        function closeProductModal() { document.getElementById('productModal').style.display = 'none'; }

        // Cart Logic
        function addToCart(id) {
            const p = products.find(x => x.id == id);
            cart.push(p);
            saveCartToStorage();
            updateCartCount();
            showToast(); // ÿπÿ±ÿ∂ ÿßŸÑÿßÿ¥ÿπÿßÿ± ÿ®ÿØŸÑÿßŸã ŸÖŸÜ alert
        }
        
        function showToast() {
            const x = document.getElementById("toast");
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        function updateCartCount() { document.getElementById('cart-count').innerText = cart.length; }
        
        function openCart() { 
            document.getElementById('cartModal').style.display = 'flex'; 
            renderCartItems(); calculateTotal(); 
        }
        function closeCart() { document.getElementById('cartModal').style.display = 'none'; }

        function renderCartItems() {
            const div = document.getElementById('cart-items');
            const checkoutSec = document.getElementById('checkout-section');
            div.innerHTML = '';
            
            if(cart.length === 0) {
                div.innerHTML = '<div style="text-align:center; padding:30px; color:#555;"><i class="fas fa-shopping-basket" style="font-size:3rem; margin-bottom:10px;"></i><br>ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ©</div>';
                checkoutSec.style.display = 'none'; return;
            }
            checkoutSec.style.display = 'block';
            
            cart.forEach((item, idx) => {
                div.innerHTML += `
                    <div style="background:#222; padding:10px; border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; border:1px solid #333;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <img src="${item.image}" style="width:50px; height:50px; object-fit:cover; border-radius:5px;">
                            <div>
                                <div style="font-weight:bold; font-size:0.9rem;">${item.name}</div>
                                <div style="color:var(--gold); font-size:0.8rem;">${item.price.toLocaleString()}</div>
                            </div>
                        </div>
                        <button onclick="removeFromCart(${idx})" style="color:#ff4444; background:none; border:none; cursor:pointer;"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            });
        }

        function removeFromCart(idx) {
            cart.splice(idx,1); saveCartToStorage(); renderCartItems(); updateCartCount(); calculateTotal();
        }

        function calculateTotal() {
            let prodTotal = cart.reduce((sum, item) => sum + item.price, 0);
            const govName = document.getElementById('cust-gov').value;
            let delPrice = deliveryRates[govName] || 0;

            document.getElementById('sub-total').innerText = prodTotal.toLocaleString();
            document.getElementById('delivery-cost').innerText = delPrice.toLocaleString();
            document.getElementById('final-total').innerText = (prodTotal + delPrice).toLocaleString() + ' ÿØ.ÿπ';
            return { prodTotal, delPrice, finalTotal: prodTotal + delPrice };
        }

        function getLocation() {
            const btn = document.getElementById('gps-btn-el');
            const mapInput = document.getElementById('google-map-link');
            if (!navigator.geolocation) { alert("ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ"); return; }
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ÿØŸäÿØ...';
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    mapInput.value = `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
                    btn.innerHTML = '<i class="fas fa-check"></i> ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ';
                    btn.style.color = '#4CAF50'; btn.style.borderColor = '#4CAF50';
                },
                () => { btn.innerHTML = '‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿØ'; }
            );
        }

        function sendOrder() {
            const name = document.getElementById('cust-name').value;
            const gov = document.getElementById('cust-gov').value;
            const phone = document.getElementById('cust-phone').value;
            const mapLink = document.getElementById('google-map-link').value;
            const totals = calculateTotal();

            if(!name || !gov || !phone) { alert("Ÿäÿ±ÿ¨Ÿâ ÿ•ŸÉŸÖÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©"); return; }

            let msg = `*ÿ∑ŸÑÿ® ÿ¨ÿØŸäÿØ ŸÖŸÜ NUVIA* ‚öúÔ∏è\n\n`;
            msg += `üë§ ÿßŸÑÿπŸÖŸäŸÑ: ${name}\nüì± ÿßŸÑŸáÿßÿ™ŸÅ: ${phone}\nüìç ÿßŸÑÿπŸÜŸàÿßŸÜ: ${gov}\n`;
            if(mapLink) msg += `üó∫Ô∏è ÿßŸÑŸÖŸàŸÇÿπ: ${mapLink}\n`;
            
            msg += `\nüõí *ÿßŸÑÿ∑ŸÑÿ®Ÿäÿ©:*\n`;
            cart.forEach(item => msg += `‚ñ™Ô∏è ${item.name} - ${item.price.toLocaleString()}\n`);

            msg += `\nüíµ ÿßŸÑŸÖÿ¨ŸÖŸàÿπ: ${totals.prodTotal.toLocaleString()}\n`;
            msg += `üöö ÿßŸÑÿ™ŸàÿµŸäŸÑ: ${totals.delPrice.toLocaleString()}\n`;
            msg += `üí∞ *ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÜŸáÿßÿ¶Ÿä: ${totals.finalTotal.toLocaleString()} ÿØ.ÿπ*`;

            const targetPhone = storePhone || '9647700000000';
            window.open(`https://wa.me/${targetPhone}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const result = [];
            for(let i=1; i<lines.length; i++) {
                if(!lines[i].trim()) continue;
                const obj = {};
                const currentline = lines[i].split(',');
                for(let j=0; j<headers.length; j++) obj[headers[j]] = currentline[j] ? currentline[j].trim() : "";
                result.push(obj);
            }
            return result;
        }
    </script>
</body>
</html>
